<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin KELAS 5</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
        // Firebase Storage imports REMOVED as we are using Base64 directly in Firestore

        // Variabel global yang disediakan oleh lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // const storage = getStorage(app); // Firebase Storage initialization REMOVED

        // Export Firebase instances and functions to global scope for use in the main script
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        // window.firebaseStorage = storage; // Export storage REMOVED
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.orderBy = orderBy;
        window.appId = appId;
        window.initialAuthToken = initialAuthToken;
        // window.ref = ref; // Export ref for storage operations REMOVED
        // window.uploadBytes = uploadBytes; // Export uploadBytes for storage operations REMOVED
        // window.getDownloadURL = getDownloadURL; // Export getDownloadURL for storage operations REMOVED
        // window.deleteObject = deleteObject; // Export deleteObject for storage operations REMOVED
    </script>
    <!-- jsPDF and html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Aturan CSS dasar untuk area cetak */
        .print-area {
            background-color: #fff;
            padding: 15px;
        }
        @media print {
            .print-area .flex.gap-3 {
                display: none; /* Sembunyikan tombol aksi saat mencetak */
            }
        }
        /* Penyesuaian Lucide Icons untuk HTML biasa */
        .lucide {
            display: inline-block; /* Agar ikon sejajar dengan teks */
            vertical-align: middle;
        }
         /* Loading overlay style */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 font-sans min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-700 text-lg">Memuat data...</p>
    </div>

    <!-- Kontainer Aplikasi -->
    <div id="app-container" class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-sm shadow-sm p-4 flex justify-between items-center sticky top-0 z-10 rounded-b-lg">
            <div>
                <div class="text-xl font-bold text-blue-600">Admin KELAS 5</div>
                <p class="text-xs text-gray-400 -mt-1">developed by Cikgu Tere</p>
            </div>
            <div class="flex items-center">
                <span id="guru-name" class="text-gray-700 mr-3 hidden sm:inline"></span>
                <img id="guru-photo" src="" alt="Foto Profil" class="w-10 h-10 rounded-full mr-4 cursor-pointer object-cover border-2 border-blue-200" />
                <!-- User ID display removed -->
                <button id="logout-button" class="text-gray-500 hover:text-red-500 transition-colors">
                    <i data-lucide="log-out" class="lucide lucide-log-out" style="width: 24px; height: 24px;"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="p-4 sm:p-6 lg:p-8 flex-1">
            <!-- Content will be rendered here by JavaScript -->
        </main>
    </div>

    <!-- Modal Pesan Umum -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative">
            <button id="message-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="lucide lucide-x" style="width: 24px; height: 24px;"></i>
            </button>
            <h2 id="message-modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            <p id="message-modal-message" class="text-gray-700"></p>
            <div class="mt-4 flex justify-end">
                <button id="message-modal-ok" class="py-2 px-4 bg-blue-500 text-white rounded-lg">Oke</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit/Add (dynamic content based on active form) -->
    <div id="data-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative">
            <button id="data-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="lucide lucide-x" style="width: 24px; height: 24px;"></i>
            </button>
            <h2 id="data-modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            <form id="data-modal-form" class="space-y-4"></form>
            <div class="mt-6 flex justify-end gap-3">
                <button id="data-modal-cancel" type="button" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                <button id="data-modal-submit" type="submit" class="py-2 px-4 bg-blue-500 text-white rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 justify-center items-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative">
            <button id="confirm-delete-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="lucide lucide-x" style="width: 24px; height: 24px;"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Konfirmasi Hapus</h2>
            <p id="confirm-delete-modal-message" class="text-gray-700 mb-4">Apakah Anda yakin ingin menghapus item ini?</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-delete-modal-cancel" type="button" class="py-2 px-4 bg-gray-200 rounded-lg">Batal</button>
                <button id="confirm-delete-modal-confirm" type="button" class="py-2 px-4 bg-red-500 text-white rounded-lg">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600 p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Selamat Datang</h2>
            <p class="text-gray-600 mb-6">Silakan masuk untuk melanjutkan ke Admin Kelas 5.</p>
            <button id="login-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                Masuk
            </button>
        </div>
    </div>

    <script type="module">
        // Pastikan Firebase sudah dimuat sebelum menjalankan script utama
        window.addEventListener('load', async () => {
            // Inisialisasi ikon Lucide
            lucide.createIcons();

            // --- Data Mock Awal (akan digunakan jika Firestore kosong atau untuk inisialisasi pertama) ---
            let initialStudentData = [
                { id: '1', nisn: '0051234567', name: 'Budi Santoso', gender: 'Laki-laki', birthPlace: 'Jakarta', birthDate: '2013-05-10', parent: 'Ahmad Santoso', address: 'Jl. Merdeka No. 1' },
                { id: '2', nisn: '0051234568', name: 'Citra Lestari', gender: 'Perempuan', birthPlace: 'Bandung', birthDate: '2013-08-15', parent: 'Dewi Lestari', address: 'Jl. Pahlawan No. 22' },
                { id: '3', nisn: '0051234569', name: 'Eka Wijaya', gender: 'Laki-laki', birthPlace: 'Surabaya', birthDate: '2014-01-20', parent: 'Joko Wijaya', address: 'Jl. Kenanga No. 5' },
                { id: '4', nisn: '0051234570', name: 'Fani Indah', gender: 'Perempuan', birthPlace: 'Bogor', birthDate: '2013-03-25', parent: 'Siti Aminah', address: 'Jl. Mawar No. 10' },
                { id: '5', nisn: '0051234571', name: 'Gilang Ramadhan', gender: 'Laki-laki', birthPlace: 'Semarang', birthDate: '2014-07-01', parent: 'Wahyu Nugroho', address: 'Jl. Anggrek No. 15' },
            ];

            let initialSchedule = {
                Senin: [{ id: '1', time: '07:30 - 09:00', subject: 'Matematika' }, { id: '2', time: '09:30 - 11:00', subject: 'Bahasa Indonesia' }],
                Selasa: [{ id: '3', time: '07:30 - 09:00', subject: 'IPA' }, { id: '4', time: '09:30 - 11:00', subject: 'IPS' }],
                Rabu: [{ id: '5', time: '07:30 - 09:00', subject: 'PPKn' }, { id: '6', time: '09:30 - 11:00', subject: 'Seni Budaya' }],
                Kamis: [{ id: '7', time: '07:30 - 09:00', subject: 'Bahasa Inggris' }, { id: '8', time: '09:30 - 11:00', subject: 'PJOK' }],
                Jumat: [{ id: '9', time: '07:30 - 09:00', subject: 'Pramuka' }],
            };

            let initialGuruProfile = {
                name: 'Anisa Pujiastuti, S.Pd.',
                nip: '198508172010012001',
                email: 'anisa.p@guru.sd.belajar.id',
                whatsapp: '081234567890',
                photo: 'https://placehold.co/128x128/E0E7FF/4F46E5?text=Foto'
            };

            let initialDaftarHadir = [
                { id: '1', date: '2025-07-01', studentName: 'Budi Santoso', status: 'Hadir' },
                { id: '2', date: '2025-07-01', studentName: 'Citra Lestari', status: 'Hadir' },
                { id: '3', date: '2025-07-01', studentName: 'Eka Wijaya', status: 'Alpha' },
                { id: '4', date: '2025-07-01', studentName: 'Fani Indah', status: 'Hadir' },
                { id: '5', date: '2025-07-01', studentName: 'Gilang Ramadhan', status: 'Sakit' },
                { id: '6', date: '2025-07-02', studentName: 'Budi Santoso', status: 'Hadir' },
                { id: '7', date: '2025-07-02', studentName: 'Citra Lestari', status: 'Izin' },
                { id: '8', date: '2025-07-02', studentName: 'Eka Wijaya', status: 'Hadir' },
                { id: '9', date: '2025-07-02', studentName: 'Fani Indah', status: 'Hadir' },
                { id: '10', date: '2025-07-02', studentName: 'Gilang Ramadhan', status: 'Hadir' },
                { id: '11', date: '2025-07-03', studentName: 'Budi Santoso', status: 'Hadir' },
                { id: '12', date: '2025-07-03', studentName: 'Citra Lestari', status: 'Hadir' },
                { id: '13', date: '2025-07-03', studentName: 'Eka Wijaya', status: 'Hadir' },
                { id: '14', date: '2025-07-03', studentName: 'Fani Indah', status: 'Alpha' },
                { id: '15', date: '2025-07-03', studentName: 'Gilang Ramadhan', status: 'Sakit' },
                { id: '16', date: '2025-08-01', studentName: 'Budi Santoso', status: 'Hadir' },
                { id: '17', date: '2025-08-01', studentName: 'Citra Lestari', status: 'Hadir' },
                { id: '18', date: '2025-08-01', studentName: 'Eka Wijaya', status: 'Hadir' },
                { id: '19', date: '2025-08-01', studentName: 'Fani Indah', status: 'Hadir' },
                { id: '20', date: '2025-08-01', studentName: 'Gilang Ramadhan', status: 'Hadir' },
            ];

            let initialProgramSemesterTahunan = [
                { id: '1', programName: 'Penyusunan RPP Semester Ganjil', description: 'Menyusun Rencana Pelaksanaan Pembelajaran untuk semester ganjil tahun ajaran 2025/2026.', year: '2025' },
                { id: '2', programName: 'Evaluasi Pembelajaran IPA', description: 'Evaluasi hasil pembelajaran mata pelajaran IPA kelas 5.', year: '2025' },
            ];

            let initialKalenderPendidikan = [
                { id: '1', eventName: 'Libur Idul Adha', date: '2025-06-17', notes: 'Libur Nasional' },
                { id: '2', eventName: 'Penilaian Tengah Semester Ganjil', date: '2025-09-20', notes: 'Meliputi semua mata pelajaran' },
            ];

            let initialAsesmen = [
                { id: '1', assessmentName: 'Ulangan Harian Matematika - Pecahan', date: '2025-07-15', subject: 'Matematika', link: 'https://docs.google.com/forms/d/e/1FAIpQLSc_example_math/viewform' },
                { id: '2', assessmentName: 'Proyek Sains - Ekosistem', date: '2025-08-01', subject: 'IPA', link: 'https://docs.google.com/document/d/1C_example_project/edit' },
                { id: '3', assessmentName: 'Kuis Sejarah - Pahlawan Nasional', date: '2025-08-10', subject: 'IPS', link: 'https://quizizz.com/admin/quiz/61_example_history/start' },
            ];

            let initialKaryaInovatif = [
                { id: '1', workTitle: 'Media Pembelajaran Interaktif "Pecahan Asyik"', description: 'Aplikasi interaktif untuk membantu siswa memahami konsep pecahan.', year: '2024' },
                { id: '2', workTitle: 'Modul Digital IPS Kelas 5', description: 'Modul pembelajaran IPS berbasis digital dengan video dan kuis interaktif.', year: '2023' },
            ];

            let initialProgramKerjaGuru = [
                { id: '1', programName: 'Peningkatan Minat Baca Siswa', description: 'Mengadakan program membaca 15 menit sebelum pelajaran dimulai.', status: 'Berjalan' },
                { id: '2', programName: 'Pembinaan Olimpiade Sains', description: 'Membimbing siswa terpilih untuk persiapan olimpiade sains.', status: 'Belum Dimulai' },
            ];

            let initialModulAjar = [
                {id: '1', title: 'Modul Matematika - Pecahan', link: 'https://docs.google.com/document/d/1example/edit'},
                {id: '2', title: 'Modul IPA - Ekosistem', link: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'}
            ];

            let initialRiwayatPelatihan = [
                {id: '1', topic: 'Kurikulum Merdeka', organizer: 'Dinas Pendidikan', date: '2024-03-10'}
            ];

            let initialDaftarNilai = [
                { id: '1', subjectName: 'Matematika', googleSheetLink: 'https://docs.google.com/spreadsheets/d/1B-z_example_math/edit?usp=sharing' },
                { id: '2', subjectName: 'Bahasa Indonesia', googleSheetLink: 'https://docs.google.com/spreadsheets/d/1A-y_example_indo/edit?usp=sharing' },
                { id: '3', subjectName: 'IPA', googleSheetLink: 'https://docs.google.com/spreadsheets/d/1C-x_example_ipa/edit?usp=sharing' },
            ];

            // --- Global State ---
            let isLoggedIn = false;
            let activeMenu = 'Dashboard';
            let userId = null;
            let db, auth; // Firebase instances, storage is removed

            // Data state (will be populated from Firestore)
            let guruProfile = { ...initialGuruProfile }; // Always load immediately
            let studentData = [];
            let schedule = JSON.parse(JSON.stringify(initialSchedule)); // Deep copy for nested objects, will be updated by snapshot
            let daftarHadir = [];
            let programSemesterTahunan = [];
            let kalenderPendidikan = [];
            let daftarNilai = [];
            let asesmen = [];
            let karyaInovatif = [];
            let programKerjaGuru = [];
            let modulAjar = [];
            let riwayatPelatihan = [];

            // Flags to track if data for a module has been fetched/initialized
            let studentsLoaded = false;
            let scheduleLoaded = false;
            let daftarHadirLoaded = false;
            let programSemesterTahunanLoaded = false;
            let kalenderPendidikanLoaded = false;
            let daftarNilaiLoaded = false;
            let asesmenLoaded = false;
            let karyaInovatifLoaded = false;
            let programKerjaGuruLoaded = false;
            let modulAjarLoaded = false;
            let riwayatPelatihanLoaded = false;


            let messageModal = { isOpen: false, title: '', message: '' };
            let dataModal = { isOpen: false, title: '', formHtml: '' };
            let confirmDeleteModal = { isOpen: false, message: '', onConfirm: null };

            let editingItem = null; // Used for generic edit modal
            let itemToDelete = null; // Used for generic delete confirmation

            let selectedDateDaftarHadir = ''; // State for filtering daftar hadir

            // --- DOM Elements ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContainer = document.getElementById('app-container');
            const mainContent = document.getElementById('main-content');
            const guruNameSpan = document.getElementById('guru-name');
            const guruPhotoImg = document.getElementById('guru-photo');
            const logoutButton = document.getElementById('logout-button');
            const loginPage = document.getElementById('login-page');
            const loginButton = document.getElementById('login-button');

            const messageModalElem = document.getElementById('message-modal');
            const messageModalTitleElem = document.getElementById('message-modal-title');
            const messageModalMessageElem = document.getElementById('message-modal-message');
            const messageModalCloseButton = document.getElementById('message-modal-close');
            const messageModalOkButton = document.getElementById('message-modal-ok');

            const dataModalElem = document.getElementById('data-modal');
            const dataModalTitleElem = document.getElementById('data-modal-title');
            const dataModalFormElem = document.getElementById('data-modal-form');
            const dataModalCloseButton = document.getElementById('data-modal-close');
            const dataModalCancelButton = document.getElementById('data-modal-cancel');
            const dataModalSubmitButton = document.getElementById('data-modal-submit');

            const confirmDeleteModalElem = document.getElementById('confirm-delete-modal');
            const confirmDeleteModalMessageElem = document.getElementById('confirm-delete-modal-message');
            const confirmDeleteModalCloseButton = document.getElementById('confirm-delete-modal-close');
            const confirmDeleteModalCancelButton = document.getElementById('confirm-delete-modal-cancel');
            const confirmDeleteModalConfirmButton = document.getElementById('confirm-delete-modal-confirm');

            // --- Firebase Initialization and Auth ---
            // Wait for Firebase to be globally available
            await new Promise(resolve => {
                const checkFirebase = setInterval(() => {
                    if (window.firebaseApp && window.firebaseDb && window.firebaseAuth) { // Removed firebaseStorage check
                        db = window.firebaseDb;
                        auth = window.firebaseAuth;
                        // storage = window.firebaseStorage; // Removed storage assignment
                        clearInterval(checkFirebase);
                        resolve();
                    }
                }, 100);
            });

            // Set up Auth state listener
            window.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isLoggedIn = true;
                    await fetchGuruProfile(); // Only fetch guru profile on initial auth
                } else {
                    // Try to sign in anonymously with custom token if available
                    if (window.initialAuthToken) {
                        try {
                            await window.signInWithCustomToken(auth, window.initialAuthToken);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            await window.signInAnonymously(auth); // Fallback to anonymous
                        }
                    } else {
                        await window.signInAnonymously(auth); // Sign in anonymously
                    }
                }
                renderApp(); // Render after auth state is determined and guru profile fetched
            });

            // --- Firestore Helper Functions ---
            function getCollectionRef(collectionName) {
                if (!userId) {
                    console.error("User not authenticated. Cannot get collection reference.");
                    return null;
                }
                return window.collection(db, `artifacts/${window.appId}/users/${userId}/${collectionName}`);
            }

            function getDocRef(collectionName, docId) {
                if (!userId) {
                    console.error("User not authenticated. Cannot get document reference.");
                    return null;
                }
                return window.doc(db, `artifacts/${window.appId}/users/${userId}/${collectionName}`, docId);
            }

            // --- Specific Data Fetching Functions (Lazy Loaded) ---
            async function fetchGuruProfile() {
                loadingOverlay.style.display = 'flex';
                try {
                    const guruProfileDoc = await window.getDoc(getDocRef('profile', 'guruProfileDoc'));
                    if (guruProfileDoc.exists()) {
                        guruProfile = guruProfileDoc.data();
                    } else {
                        // Set initial data if not found
                        await window.setDoc(getDocRef('profile', 'guruProfileDoc'), initialGuruProfile);
                        guruProfile = initialGuruProfile;
                    }
                } catch (error) {
                    console.error("Error fetching guru profile:", error);
                    showMessage(`Gagal memuat profil guru: ${error.message}. Coba refresh halaman.`, 'Kesalahan Data');
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function initializeStudentsListener() {
                if (studentsLoaded) return;
                studentsLoaded = true;
                window.onSnapshot(getCollectionRef('students'), (snapshot) => {
                    studentData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (studentData.length === 0) { // If Firestore is empty, use initial mock data
                        initialStudentData.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('students')), item);
                        });
                        studentData = initialStudentData; // Set local state for immediate display
                    }
                    renderApp(); // Re-render once data is loaded/updated
                });
            }

            function initializeScheduleListener() {
                if (scheduleLoaded) return;
                scheduleLoaded = true;
                window.onSnapshot(getCollectionRef('schedules'), (snapshot) => {
                    const fetchedSchedule = {};
                    snapshot.docs.forEach(doc => {
                        fetchedSchedule[doc.id] = doc.data().lessons;
                    });
                    schedule = { ...initialSchedule, ...fetchedSchedule }; // Merge with initial to ensure all days exist
                    if (Object.keys(fetchedSchedule).length === 0) { // If Firestore is empty, initialize with mock data
                        for (const day in initialSchedule) {
                            window.setDoc(getDocRef('schedules', day), { lessons: initialSchedule[day] });
                        }
                        schedule = initialSchedule; // Set local state for immediate display
                    }
                    renderApp();
                });
            }

            function initializeDaftarHadirListener() {
                if (daftarHadirLoaded) return;
                daftarHadirLoaded = true;
                window.onSnapshot(getCollectionRef('attendance'), (snapshot) => {
                    daftarHadir = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (daftarHadir.length === 0) {
                        initialDaftarHadir.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('attendance')), item);
                        });
                        daftarHadir = initialDaftarHadir;
                    }
                    renderApp();
                });
            }

            function initializeProgramSemesterTahunanListener() {
                if (programSemesterTahunanLoaded) return;
                programSemesterTahunanLoaded = true;
                window.onSnapshot(getCollectionRef('semester_programs'), (snapshot) => {
                    programSemesterTahunan = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (programSemesterTahunan.length === 0) {
                        initialProgramSemesterTahunan.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('semester_programs')), item);
                        });
                        programSemesterTahunan = initialProgramSemesterTahunan;
                    }
                    renderApp();
                });
            }

            function initializeKalenderPendidikanListener() {
                if (kalenderPendidikanLoaded) return;
                kalenderPendidikanLoaded = true;
                window.onSnapshot(getCollectionRef('calendar_events'), (snapshot) => {
                    kalenderPendidikan = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (kalenderPendidikan.length === 0) {
                        initialKalenderPendidikan.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('calendar_events')), item);
                        });
                        kalenderPendidikan = initialKalenderPendidikan;
                    }
                    renderApp();
                });
            }

            function initializeDaftarNilaiListener() {
                if (daftarNilaiLoaded) return;
                daftarNilaiLoaded = true;
                window.onSnapshot(getCollectionRef('grades'), (snapshot) => {
                    daftarNilai = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (daftarNilai.length === 0) {
                        initialDaftarNilai.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('grades')), item);
                        });
                        daftarNilai = initialDaftarNilai;
                    }
                    renderApp();
                });
            }

            function initializeAsesmenListener() {
                if (asesmenLoaded) return;
                asesmenLoaded = true;
                window.onSnapshot(getCollectionRef('assessments'), (snapshot) => {
                    asesmen = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (asesmen.length === 0) {
                        initialAsesmen.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('assessments')), item);
                        });
                        asesmen = initialAsesmen;
                    }
                    renderApp();
                });
            }

            function initializeKaryaInovatifListener() {
                if (karyaInovatifLoaded) return;
                karyaInovatifLoaded = true;
                window.onSnapshot(getCollectionRef('innovative_works'), (snapshot) => {
                    karyaInovatif = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (karyaInovatif.length === 0) {
                        initialKaryaInovatif.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('innovative_works')), item);
                        });
                        karyaInovatif = initialKaryaInovatif;
                    }
                    renderApp();
                });
            }

            function initializeProgramKerjaGuruListener() {
                if (programKerjaGuruLoaded) return;
                programKerjaGuruLoaded = true;
                window.onSnapshot(getCollectionRef('teacher_programs'), (snapshot) => {
                    programKerjaGuru = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (programKerjaGuru.length === 0) {
                        initialProgramKerjaGuru.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('teacher_programs')), item);
                        });
                        programKerjaGuru = initialProgramKerjaGuru;
                    }
                    renderApp();
                });
            }

            function initializeModulAjarListener() {
                if (modulAjarLoaded) return;
                modulAjarLoaded = true;
                window.onSnapshot(getCollectionRef('teaching_modules'), (snapshot) => {
                    modulAjar = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (modulAjar.length === 0) {
                        initialModulAjar.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('teaching_modules')), item);
                        });
                        modulAjar = initialModulAjar;
                    }
                    renderApp();
                });
            }

            function initializeRiwayatPelatihanListener() {
                if (riwayatPelatihanLoaded) return;
                riwayatPelatihanLoaded = true;
                window.onSnapshot(getCollectionRef('trainings'), (snapshot) => {
                    riwayatPelatihan = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (riwayatPelatihan.length === 0) {
                        initialRiwayatPelatihan.forEach(async (item) => {
                            await window.setDoc(window.doc(getCollectionRef('trainings')), item);
                        });
                        riwayatPelatihan = initialRiwayatPelatihan;
                    }
                    renderApp();
                });
            }

            // --- Base64 Photo Handling (replaces Firebase Storage logic) ---
            async function convertFileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // --- Helper Functions ---
            function showMessage(message, title = 'Informasi') {
                messageModal.isOpen = true;
                messageModal.title = title;
                messageModal.message = message;
                renderApp(); // Re-render to show modal
            }

            function closeMessageModal() {
                messageModal.isOpen = false;
                renderApp();
            }

            function showDataModal(title, formHtml, submitCallback) {
                dataModal.isOpen = true;
                dataModal.title = title;
                dataModal.formHtml = formHtml;
                renderApp(); // Render to update modal HTML first

                dataModalSubmitButton.onclick = (e) => {
                    e.preventDefault();
                    submitCallback(dataModalFormElem); // Pass the actual form element to the callback
                };
                dataModalCancelButton.onclick = closeDataModal;
            }

            function closeDataModal() {
                dataModal.isOpen = false;
                editingItem = null; // Clear editing item
                renderApp();
            }

            function showConfirmDeleteModal(message, onConfirm) {
                confirmDeleteModal.isOpen = true;
                confirmDeleteModal.message = message;
                confirmDeleteModal.onConfirm = onConfirm;
                renderApp();
            }

            function closeConfirmDeleteModal() {
                confirmDeleteModal.isOpen = false;
                confirmDeleteModal.onConfirm = null;
                itemToDelete = null; // Clear item to delete
                renderApp();
            }

            // Generic Header component (rendered dynamically)
            function renderHeader(title, iconHtml, onBack = null, onAdd = null, showGlobalDownload = true) {
                let backButtonHtml = onBack ? `<button onclick="handleBack('${onBack}')" class="mr-4 text-gray-500 hover:text-blue-600 transition-colors"> <i data-lucide="arrow-left" class="lucide lucide-arrow-left" style="width: 24px; height: 24px;"></i> </button>` : '';
                let addButtonHtml = onAdd ? `<button onclick="${onAdd}" class="flex-1 sm:flex-initial flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-sm"> <i data-lucide="plus-circle" class="lucide lucide-plus-circle mr-2" style="width: 18px; height: 18px;"></i> Tambah </button>` : '';
                let downloadButtonHtml = showGlobalDownload ? `<button onclick="handleDownloadCurrentPage()" class="flex-1 sm:flex-initial flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-sm"> <i data-lucide="download" class="lucide lucide-download mr-2" style="width: 18px; height: 18px;"></i> PDF </button>` : '';

                return `
                    <div class="bg-white p-4 shadow-md rounded-lg mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-center">
                            ${backButtonHtml}
                            <div class="bg-blue-100 text-blue-600 p-3 rounded-lg mr-4"> ${iconHtml} </div>
                            <h1 class="text-2xl font-bold text-gray-800">${title}</h1>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            ${addButtonHtml}
                            ${downloadButtonHtml}
                        </div>
                    </div>
                `;
            }

            function handleBack(menu) {
                activeMenu = menu;
                renderApp();
            }

            // --- PDF Download Functionality ---
            async function handleDownloadCurrentPage() {
                const printArea = mainContent.querySelector('.print-area');
                if (!printArea) {
                    showMessage('Konten tidak ditemukan untuk diunduh.', 'Kesalahan Unduh');
                    return;
                }

                if (typeof window.html2canvas === 'undefined' || typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                    showMessage('Perpustakaan unduhan PDF belum dimuat. Mohon tunggu sebentar.', 'Mohon Tunggu');
                    return;
                }

                try {
                    const canvas = await html2canvas(printArea, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; // Lebar A4 dalam mm
                    const pageHeight = 297; // Tinggi A4 dalam mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    let filename = activeMenu.replace(/\s+/g, '_').toLowerCase() + '.pdf';
                    pdf.save(filename);
                    showMessage('Dokumen berhasil diunduh sebagai PDF.', 'Unduh Berhasil');
                } catch (error) {
                    console.error('Kesalahan saat membuat PDF:', error);
                    showMessage('Gagal mengunduh dokumen PDF. Coba lagi.', 'Kesalahan Unduh');
                }
            }

            // Function to download PDF for a specific module (Modul Ajar)
            async function downloadSingleModulAjar(moduleId) {
                const module = modulAjar.find(m => m.id === moduleId);
                if (!module) {
                    showMessage('Modul tidak ditemukan untuk diunduh.', 'Kesalahan Unduh');
                    return;
                }

                if (typeof window.html2canvas === 'undefined' || typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                    showMessage('Perpustakaan unduhan PDF belum dimuat. Mohon tunggu sebentar.', 'Mohon Tunggu');
                    return;
                }

                // Periksa apakah link langsung ke file PDF
                if (module.link.toLowerCase().endsWith('.pdf')) {
                    // Jika ini adalah link PDF, coba buka langsung (browser akan menangani unduhan/tampilan)
                    window.open(module.link, '_blank');
                    showMessage('Membuka/Mengunduh file PDF...', 'Unduh Dokumen');
                    return;
                }

                // Jika bukan link PDF langsung, buat PDF berisi metadata modul
                try {
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px'; // Sembunyikan di luar layar
                    tempDiv.style.width = '800px'; // Beri lebar tetap untuk rendering yang konsisten
                    tempDiv.style.backgroundColor = '#fff';
                    tempDiv.style.padding = '20px';
                    tempDiv.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4">Modul Ajar: ${module.title}</h2>
                        <p class="text-gray-700 mb-2">Link Modul: <a href="${module.link}" target="_blank" rel="noopener noreferrer">${module.link}</a></p>
                        <p class="text-gray-500 text-sm">Dibuat pada: ${new Date().toLocaleDateString('id-ID')}</p>
                    `;
                    document.body.appendChild(tempDiv);

                    const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const imgHeight = canvas.height * imgWidth / canvas.width;

                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    pdf.save(`modul_ajar_${module.title.replace(/\s+/g, '_').toLowerCase()}.pdf`);

                    document.body.removeChild(tempDiv);
                    showMessage('Detail modul ajar berhasil diunduh sebagai PDF.', 'Unduh Berhasil');
                } catch (error) {
                    console.error('Kesalahan saat membuat PDF modul ajar:', error);
                    showMessage('Gagal mengunduh modul ajar PDF. Coba lagi.', 'Kesalahan Unduh');
                }
            }
            window.downloadSingleModulAjar = downloadSingleModulAjar; // Expose to global scope


            // --- Komponen Tampilan Konten (sebagai fungsi yang mengembalikan string HTML) ---

            function renderProfilGuruContent() {
                let photoPreviewHtml = guruProfile.photo ? `
                    <div class="mt-4 flex items-center gap-4 p-2 border rounded-lg bg-gray-50">
                        <img id="modal-preview-photo" src="${guruProfile.photo}" onerror="this.onerror=null; this.src='https://placehold.co/128x128/E0E7FF/4F46E5?text=Gagal+Muat';" alt="Pratinjau Foto" class="w-20 h-20 rounded-full object-cover shadow-sm border border-gray-200" />
                        <button type="button" id="clear-photo-button" class="flex items-center text-red-500 hover:text-red-700 transition-colors px-3 py-1 rounded-md border border-red-300 bg-white hover:bg-red-50">
                            <i data-lucide="trash-2" class="lucide lucide-trash-2 mr-1" style="width: 16px; height: 16px;"></i> Hapus Foto
                        </button>
                    </div>
                ` : '';

                const formHtml = `
                    <input name="name" placeholder="Nama Lengkap" value="${guruProfile.name}" class="w-full p-2 border rounded" required />
                    <input name="nip" placeholder="NIP" value="${guruProfile.nip}" class="w-full p-2 border rounded" required />
                    <input name="email" type="email" placeholder="Email" value="${guruProfile.email}" class="w-full p-2 border rounded" required />
                    <input name="whatsapp" placeholder="Nomor Whatsapp" value="${guruProfile.whatsapp}" class="w-full p-2 border rounded" />
                    <label for="photoFile" class="block text-gray-700 text-sm font-bold mb-1">Unggah Foto Profil (Ukuran Max 100KB - untuk performa)</label>
                    <input type="file" id="photoFile" name="photoFile" accept="image/*" class="w-full p-2 border rounded file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                    ${photoPreviewHtml}
                `;

                const handleSaveProfile = async (formElement) => {
                    const formData = new FormData(formElement);
                    const photoFile = formData.get('photoFile');
                    let newPhotoUrl = guruProfile.photo; // Default to current photo

                    if (photoFile && photoFile.size > 0) {
                        const MAX_FILE_SIZE_BYTES = 100 * 1024; // 100 KB for Base64 in Firestore
                        if (photoFile.size > MAX_FILE_SIZE_BYTES) {
                            showMessage(`Ukuran file foto maksimum adalah ${MAX_FILE_SIZE_BYTES / 1024} KB.`, 'Ukuran File Terlalu Besar');
                            return;
                        }
                        loadingOverlay.style.display = 'flex'; // Tampilkan loading
                        try {
                            const base64Image = await convertFileToBase64(photoFile);
                            newPhotoUrl = base64Image;
                        } catch (error) {
                            console.error("Error converting image to Base64:", error);
                            showMessage(`Gagal memproses foto: ${error.message}`, 'Kesalahan Pemrosesan');
                            loadingOverlay.style.display = 'none'; // Sembunyikan loading
                            return;
                        } finally {
                            loadingOverlay.style.display = 'none'; // Sembunyikan loading
                        }
                    } else if (photoFile && photoFile.size === 0) {
                         // This case handles when a file input is cleared but no new file is chosen.
                         // The logic for clearing the photo to placeholder is already handled by clear-photo-button.
                         // So, if it's just an empty file input and no explicit clear, keep the old photo.
                         newPhotoUrl = guruProfile.photo;
                    }


                    const updatedProfile = {
                        name: formData.get('name'),
                        nip: formData.get('nip'),
                        email: formData.get('email'),
                        whatsapp: formData.get('whatsapp'),
                        photo: newPhotoUrl
                    };

                    try {
                        await window.setDoc(getDocRef('profile', 'guruProfileDoc'), updatedProfile);
                        guruProfile = updatedProfile; // Update local state immediately
                        closeDataModal();
                        showMessage('Profil guru berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating guru profile:", error);
                        showMessage(`Gagal memperbarui profil guru: ${error.message}. Coba gunakan foto dengan ukuran lebih kecil.`, 'Kesalahan');
                    }
                };

                // Returns the HTML string for the profile content
                const contentHtml = `
                    <div id="profile-print-area" class="bg-white p-8 rounded-lg shadow-md flex flex-col md:flex-row items-center gap-8 print-area">
                        <div class="flex-shrink-0">
                            <img src="${guruProfile.photo}" onerror="this.onerror=null; this.src='https://placehold.co/128x128/E0E7FF/4F46E5?text=Gagal+Muat';" alt="Foto Profil Guru" class="w-32 h-32 rounded-full object-cover shadow-lg border-4 border-blue-200" />
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-3xl font-bold text-gray-800">${guruProfile.name}</h2>
                            <p class="text-lg text-gray-500 mb-4">NIP. ${guruProfile.nip}</p>
                            <div class="space-y-2">
                                <div class="flex items-center text-gray-700"> <i data-lucide="mail" class="lucide lucide-mail mr-3 text-blue-500" style="width: 20px; height: 20px;"></i> <span>${guruProfile.email}</span> </div>
                                <div class="flex items-center text-gray-700"> <i data-lucide="phone" class="lucide lucide-phone mr-3 text-green-500" style="width: 20px; height: 20px;"></i> <span>${guruProfile.whatsapp}</span> </div>
                            </div>
                        </div>
                        <button id="edit-profile-button" class="mt-4 md:mt-0 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-sm flex items-center"> <i data-lucide="edit" class="lucide lucide-edit mr-2" style="width: 18px; height: 18px;"></i> Ubah Profil </button>
                    </div>
                `;

                // After rendering, attach event listeners
                setTimeout(() => { // Use setTimeout to ensure elements are in DOM
                    const editButton = document.getElementById('edit-profile-button');
                    if (editButton) {
                        editButton.onclick = () => {
                            showDataModal("Ubah Profil Guru", formHtml, handleSaveProfile);
                            const photoFileInput = document.getElementById('photoFile');
                            if (photoFileInput) {
                                photoFileInput.onchange = (e) => {
                                    const file = e.target.files[0];
                                    if (file) {
                                        const MAX_FILE_SIZE_BYTES = 100 * 1024; // 100 KB
                                        if (file.size > MAX_FILE_SIZE_BYTES) {
                                            showMessage(`Ukuran file maksimum adalah ${MAX_FILE_SIZE_BYTES / 1024} KB.`, 'Ukuran File Terlalu Besar');
                                            e.target.value = ''; // Clear the input
                                            const modalPreviewPhoto = document.getElementById('modal-preview-photo');
                                            if (modalPreviewPhoto) modalPreviewPhoto.src = guruProfile.photo; // Revert preview
                                            return;
                                        }
                                        const reader = new FileReader();
                                        reader.onloadend = () => {
                                            const modalPreviewPhoto = document.getElementById('modal-preview-photo');
                                            if (modalPreviewPhoto) modalPreviewPhoto.src = reader.result;
                                        };
                                        reader.readAsDataURL(file);
                                    } else {
                                        const modalPreviewPhoto = document.getElementById('modal-preview-photo');
                                        if (modalPreviewPhoto) modalPreviewPhoto.src = guruProfile.photo; // Revert to current photo if input is cleared
                                    }
                                };
                            }
                            const clearPhotoButton = document.getElementById('clear-photo-button');
                            if (clearPhotoButton) {
                                clearPhotoButton.onclick = async () => {
                                    guruProfile.photo = 'https://placehold.co/128x128/E0E7FF/4F46E5?text=Foto'; // Set to placeholder
                                    const modalPreviewPhoto = document.getElementById('modal-preview-photo');
                                    if (modalPreviewPhoto) modalPreviewPhoto.src = guruProfile.photo;
                                    const photoInput = document.getElementById('photoFile');
                                    if (photoInput) photoInput.value = ''; // Clear file input value

                                    try {
                                        // Update Firestore with the placeholder URL
                                        await window.updateDoc(getDocRef('profile', 'guruProfileDoc'), { photo: guruProfile.photo });
                                        showMessage('Foto profil berhasil dihapus.', 'Berhasil');
                                    } catch (error) {
                                        console.error("Error clearing photo in Firestore:", error);
                                        showMessage(`Gagal menghapus foto: ${error.message}.`, 'Kesalahan');
                                    }
                                };
                            }
                        };
                    }
                }, 0); // Short delay to ensure DOM is updated

                return contentHtml;
            }

            function renderJadwalMengajarContent() {
                // Initialize listener for this data if not already done
                initializeScheduleListener();

                let rowsHtml = '';
                const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat']; // Ensure consistent order
                for (const day of days) {
                    rowsHtml += `<div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">${day}</h3>`;
                    const lessonsForDay = schedule[day] || []; // Use fetched schedule
                    if (lessonsForDay.length > 0) {
                        rowsHtml += `<ul class="space-y-3">`;
                        lessonsForDay.forEach(lesson => {
                            rowsHtml += `
                                <li class="flex items-center justify-between bg-blue-50 p-4 rounded-lg shadow-sm">
                                    <div>
                                        <p class="text-lg font-medium text-blue-800">${lesson.time}</p>
                                        <p class="text-gray-700">${lesson.subject}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="editLesson('${day}', '${lesson.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 20px; height: 20px;"></i> </button>
                                        <button onclick="confirmDeleteLesson('${day}', '${lesson.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 20px; height: 20px;"></i> </button>
                                    </div>
                                </li>
                            `;
                        });
                        rowsHtml += `</ul>`;
                    } else {
                        rowsHtml += `<p class="text-gray-500 italic">Tidak ada jadwal untuk hari ${day}.</p>`;
                    }
                    rowsHtml += `</div>`;
                }

                const contentHtml = `
                    <div id="schedule-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        ${rowsHtml}
                    </div>
                `;
                return contentHtml;
            }

            window.addLesson = () => {
                editingItem = null;
                const formHtml = `
                    <div>
                        <label for="day" class="block text-gray-700 text-sm font-bold mb-1">Hari</label>
                        <select name="day" id="day" class="w-full p-2 border rounded" required>
                            ${Object.keys(initialSchedule).map(day => `<option value="${day}">${day}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="time" class="block text-gray-700 text-sm font-bold mb-1">Waktu</label>
                        <input type="text" name="time" id="time" placeholder="Contoh: 07:30 - 09:00" class="w-full p-2 border rounded" required />
                    </div>
                    <div>
                        <label for="subject" class="block text-gray-700 text-sm font-bold mb-1">Mata Pelajaran</label>
                        <input type="text" name="subject" id="subject" placeholder="Contoh: Matematika" class="w-full p-2 border rounded" required />
                    </div>
                `;
                showDataModal("Tambah Jadwal Pelajaran Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newLesson = {
                        id: Date.now().toString(), // Use string ID for Firestore consistency
                        time: formData.get('time'),
                        subject: formData.get('subject')
                    };
                    const day = formData.get('day');

                    try {
                        const dayDocRef = getDocRef('schedules', day);
                        const docSnap = await window.getDoc(dayDocRef);
                        let lessons = [];
                        if (docSnap.exists()) {
                            lessons = docSnap.data().lessons || [];
                        }
                        lessons.push(newLesson);
                        lessons.sort((a, b) => a.time.localeCompare(b.time)); // Sort locally
                        await window.setDoc(dayDocRef, { lessons: lessons }); // Overwrite with sorted array
                        closeDataModal();
                        showMessage('Jadwal pelajaran baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding lesson:", error);
                        showMessage(`Gagal menambahkan pelajaran: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editLesson = (day, lessonId) => {
                const lesson = schedule[day].find(l => l.id === lessonId);
                if (!lesson) return;
                editingItem = { day, lesson }; // Store original day and lesson
                const formHtml = `
                    <div>
                        <label for="day" class="block text-gray-700 text-sm font-bold mb-1">Hari</label>
                        <select name="day" id="day" class="w-full p-2 border rounded" required>
                            ${Object.keys(initialSchedule).map(d => `<option value="${d}" ${d === day ? 'selected' : ''}>${d}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="time" class="block text-gray-700 text-sm font-bold mb-1">Waktu</label>
                        <input type="text" name="time" id="time" placeholder="Contoh: 07:30 - 09:00" value="${lesson.time}" class="w-full p-2 border rounded" required />
                    </div>
                    <div>
                        <label for="subject" class="block text-gray-700 text-sm font-bold mb-1">Mata Pelajaran</label>
                        <input type="text" name="subject" id="subject" placeholder="Contoh: Matematika" value="${lesson.subject}" class="w-full p-2 border rounded" required />
                    </div>
                `;
                showDataModal("Ubah Jadwal Pelajaran", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedLesson = {
                        id: editingItem.lesson.id,
                        time: formData.get('time'),
                        subject: formData.get('subject')
                    };
                    const newDay = formData.get('day');
                    const originalDay = editingItem.day;

                    try {
                        if (originalDay !== newDay) {
                            // Remove from original day's array
                            const originalDayDocRef = getDocRef('schedules', originalDay);
                            const originalDocSnap = await window.getDoc(originalDayDocRef);
                            if (originalDocSnap.exists()) {
                                const originalLessons = originalDocSnap.data().lessons.filter(l => l.id !== updatedLesson.id);
                                await window.setDoc(originalDayDocRef, { lessons: originalLessons });
                            }

                            // Add to new day's array
                            const newDayDocRef = getDocRef('schedules', newDay);
                            const newDocSnap = await window.getDoc(newDayDocRef);
                            let newLessons = [];
                            if (newDocSnap.exists()) {
                                newLessons = newDocSnap.data().lessons || [];
                            }
                            newLessons.push(updatedLesson);
                            newLessons.sort((a, b) => a.time.localeCompare(b.time));
                            await window.setDoc(newDayDocRef, { lessons: newLessons });

                        } else {
                            // Update in the same day's array
                            const dayDocRef = getDocRef('schedules', originalDay);
                            const docSnap = await window.getDoc(dayDocRef);
                            if (docSnap.exists()) {
                                let lessons = docSnap.data().lessons || [];
                                lessons = lessons.map(l => (l.id === updatedLesson.id ? updatedLesson : l));
                                lessons.sort((a, b) => a.time.localeCompare(b.time));
                                await window.setDoc(dayDocRef, { lessons: lessons });
                            }
                        }
                        closeDataModal();
                        showMessage('Jadwal pelajaran berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error editing lesson:", error);
                        showMessage(`Gagal memperbarui pelajaran: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteLesson = (day, lessonId) => {
                itemToDelete = { day, lessonId };
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus jadwal pelajaran ini?", async () => {
                    if (!itemToDelete) return;
                    const { day, lessonId } = itemToDelete;
                    try {
                        const dayDocRef = getDocRef('schedules', day);
                        const docSnap = await window.getDoc(dayDocRef);
                        if (docSnap.exists()) {
                            const updatedLessons = docSnap.data().lessons.filter(l => l.id !== lessonId);
                            await window.setDoc(dayDocRef, { lessons: updatedLessons });
                        }
                        closeConfirmDeleteModal();
                        showMessage('Jadwal pelajaran berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting lesson:", error);
                        showMessage(`Gagal menghapus pelajaran: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderDaftarSiswaContent() {
                // Initialize listener for this data if not already done
                initializeStudentsListener();

                let rowsHtml = '';
                if (studentData.length > 0) {
                    studentData.forEach(student => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${student.nisn}</td>
                                <td class="py-3 px-4">${student.name}</td>
                                <td class="py-3 px-4">${student.gender}</td>
                                <td class="py-3 px-4">${student.birthPlace}, ${new Date(student.birthDate).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                <td class="py-3 px-4">${student.parent}</td>
                                <td class="py-3 px-4">${student.address}</td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editStudent('${student.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteStudent('${student.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="7" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada data siswa.</td></tr>`;
                }

                const contentHtml = `
                    <div id="student-list-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">NISN</th>
                                        <th class="py-3 px-4 text-left">Nama</th>
                                        <th class="py-3 px-4 text-left">Jenis Kelamin</th>
                                        <th class="py-3 px-4 text-left">Tempat, Tanggal Lahir</th>
                                        <th class="py-3 px-4 text-left">Orang Tua/Wali</th>
                                        <th class="py-3 px-4 text-left">Alamat</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addStudent = () => {
                editingItem = null;
                const formHtml = `
                    <input name="nisn" placeholder="NISN" class="w-full p-2 border rounded" required />
                    <input name="name" placeholder="Nama Lengkap" class="w-full p-2 border rounded" required />
                    <select name="gender" class="w-full p-2 border rounded" required>
                        <option value="">Pilih Jenis Kelamin</option>
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                    <input name="birthPlace" placeholder="Tempat Lahir" class="w-full p-2 border rounded" required />
                    <input type="date" name="birthDate" class="w-full p-2 border rounded" required />
                    <input name="parent" placeholder="Nama Orang Tua/Wali" class="w-full p-2 border rounded" required />
                    <textarea name="address" placeholder="Alamat Lengkap" class="w-full p-2 border rounded" rows="3"></textarea>
                `;
                showDataModal("Tambah Siswa Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newStudent = {
                        nisn: formData.get('nisn'),
                        name: formData.get('name'),
                        gender: formData.get('gender'),
                        birthPlace: formData.get('birthPlace'),
                        birthDate: formData.get('birthDate'),
                        parent: formData.get('parent'),
                        address: formData.get('address')
                    };
                    try {
                        await window.addDoc(getCollectionRef('students'), newStudent);
                        closeDataModal();
                        showMessage('Siswa baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding student:", error);
                        showMessage(`Gagal menambahkan siswa: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editStudent = (studentId) => {
                const student = studentData.find(s => s.id === studentId);
                if (!student) return;
                editingItem = student;
                const formHtml = `
                    <input name="nisn" placeholder="NISN" value="${student.nisn}" class="w-full p-2 border rounded" required />
                    <input name="name" placeholder="Nama Lengkap" value="${student.name}" class="w-full p-2 border rounded" required />
                    <select name="gender" class="w-full p-2 border rounded" required>
                        <option value="">Pilih Jenis Kelamin</option>
                        <option value="Laki-laki" ${student.gender === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                        <option value="Perempuan" ${student.gender === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                    </select>
                    <input name="birthPlace" placeholder="Tempat Lahir" value="${student.birthPlace}" class="w-full p-2 border rounded" required />
                    <input type="date" name="birthDate" value="${student.birthDate}" class="w-full p-2 border rounded" required />
                    <input name="parent" placeholder="Nama Orang Tua/Wali" value="${student.parent}" class="w-full p-2 border rounded" required />
                    <textarea name="address" placeholder="Alamat Lengkap" class="w-full p-2 border rounded" rows="3">${student.address}</textarea>
                `;
                showDataModal("Ubah Data Siswa", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedStudent = {
                        nisn: formData.get('nisn'),
                        name: formData.get('name'),
                        gender: formData.get('gender'),
                        birthPlace: formData.get('birthPlace'),
                        birthDate: formData.get('birthDate'),
                        parent: formData.get('parent'),
                        address: formData.get('address')
                    };
                    try {
                        await window.updateDoc(getDocRef('students', editingItem.id), updatedStudent);
                        closeDataModal();
                        showMessage('Data siswa berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating student:", error);
                        showMessage(`Gagal memperbarui siswa: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteStudent = (studentId) => {
                itemToDelete = studentId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus data siswa ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('students', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Data siswa berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting student:", error);
                        showMessage(`Gagal menghapus siswa: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            function renderDaftarHadirContent() {
                // Initialize listener for this data if not already done
                initializeDaftarHadirListener();

                let filteredDaftarHadir = selectedDateDaftarHadir
                    ? daftarHadir.filter(item => item.date === selectedDateDaftarHadir)
                    : daftarHadir;

                // Group attendance by date for recap
                const attendanceRecap = filteredDaftarHadir.reduce((acc, curr) => {
                    if (!acc[curr.date]) {
                    acc[curr.date] = {
                        Hadir: 0,
                        Sakit: 0,
                        Izin: 0,
                        Alpha: 0,
                        totalStudents: studentData.length
                    };
                    }
                    acc[curr.date][curr.status]++;
                    return acc;
                }, {});

                let recapHtml = '';
                if (Object.keys(attendanceRecap).length > 0) {
                    let recapRows = '';
                    Object.entries(attendanceRecap).sort((a, b) => a[0].localeCompare(b[0])).forEach(([date, data]) => {
                        recapRows += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-3">${new Date(date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                <td class="py-2 px-3">${data.Hadir}</td>
                                <td class="py-2 px-3">${data.Sakit}</td>
                                <td class="py-2 px-3">${data.Izin}</td>
                                <td class="py-2 px-3">${data.Alpha}</td>
                                <td class="py-2 px-3">${data.totalStudents}</td>
                            </tr>
                        `;
                    });
                    recapHtml = `
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr class="bg-green-100 text-green-800">
                                        <th class="py-2 px-3 text-left border-b">Tanggal</th>
                                        <th class="py-2 px-3 text-left border-b">Hadir</th>
                                        <th class="py-2 px-3 text-left border-b">Sakit</th>
                                        <th class="py-2 px-3 text-left border-b">Izin</th>
                                        <th class="py-2 px-3 text-left border-b">Alpha</th>
                                        <th class="py-2 px-3 text-left border-b">Total Siswa</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recapRows}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    recapHtml = `<p class="text-gray-500 italic mb-4">Tidak ada data rekapitulasi untuk tanggal ini.</p>`;
                }

                let detailRowsHtml = '';
                if (filteredDaftarHadir.length > 0) {
                    filteredDaftarHadir.forEach(attendance => {
                        const statusClass =
                            attendance.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                            attendance.status === 'Sakit' ? 'bg-yellow-100 text-yellow-800' :
                            attendance.status === 'Izin' ? 'bg-blue-100 text-blue-800' :
                            'bg-red-100 text-red-800';
                        detailRowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${new Date(attendance.date).toLocaleDateString('id-ID')}</td>
                                <td class="py-3 px-4">${attendance.studentName}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">
                                        ${attendance.status}
                                    </span>
                                </td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editAttendance('${attendance.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteAttendance('${attendance.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    detailRowsHtml = `<tr><td colspan="4" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada data kehadiran.</td></tr>`;
                }

                const contentHtml = `
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Filter Berdasarkan Tanggal</h3>
                        <input type="date" id="attendance-date-filter" value="${selectedDateDaftarHadir}" class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                        ${selectedDateDaftarHadir ? `<button onclick="clearAttendanceDateFilter()" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded-lg text-sm">Hapus Filter</button>` : ''}
                    </div>
                    <div id="daftar-hadir-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Rekapitulasi Kehadiran</h3>
                        ${recapHtml}
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Detail Kehadiran</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Tanggal</th>
                                        <th class="py-3 px-4 text-left">Nama Siswa</th>
                                        <th class="py-3 px-4 text-left">Status</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${detailRowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                // Attach event listener for the filter after rendering
                setTimeout(() => {
                    document.getElementById('attendance-date-filter').onchange = (e) => {
                        selectedDateDaftarHadir = e.target.value;
                        renderApp(); // Re-render to apply filter
                    };
                }, 0);
                return contentHtml;
            }

            window.clearAttendanceDateFilter = () => {
                selectedDateDaftarHadir = '';
                renderApp(); // Re-render to clear filter
            };

            window.addAttendance = () => {
                editingItem = null;
                const studentOptions = studentData.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                const formHtml = `
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" class="w-full p-2 border rounded" required />
                    </div>
                    <div>
                        <label for="studentName" class="block text-gray-700 text-sm font-bold mb-1">Nama Siswa</label>
                        <select name="studentName" id="studentName" class="w-full p-2 border rounded" required>
                            <option value="">Pilih Siswa</option>
                            ${studentOptions}
                        </select>
                    </div>
                    <div>
                        <label for="status" class="block text-gray-700 text-sm font-bold mb-1">Status</label>
                        <select name="status" id="status" class="w-full p-2 border rounded" required>
                            <option value="">Pilih Status</option>
                            <option value="Hadir">Hadir</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Izin">Izin</option>
                            <option value="Alpha">Alpha</option>
                        </select>
                    </div>
                `;
                showDataModal("Tambah Data Kehadiran Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newAttendance = {
                        date: formData.get('date'),
                        studentName: formData.get('studentName'),
                        status: formData.get('status')
                    };
                    try {
                        await window.addDoc(getCollectionRef('attendance'), newAttendance);
                        closeDataModal();
                        showMessage('Data kehadiran baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding attendance:", error);
                        showMessage(`Gagal menambahkan kehadiran: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editAttendance = (attendanceId) => {
                const attendance = daftarHadir.find(a => a.id === attendanceId);
                if (!attendance) return;
                editingItem = attendance;
                const studentOptions = studentData.map(s => `<option value="${s.name}" ${s.name === attendance.studentName ? 'selected' : ''}>${s.name}</option>`).join('');
                const formHtml = `
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" value="${attendance.date}" class="w-full p-2 border rounded" required />
                    </div>
                    <div>
                        <label for="studentName" class="block text-gray-700 text-sm font-bold mb-1">Nama Siswa</label>
                        <select name="studentName" id="studentName" class="w-full p-2 border rounded" required>
                            <option value="">Pilih Siswa</option>
                            ${studentOptions}
                        </select>
                    </div>
                    <div>
                        <label for="status" class="block text-gray-700 text-sm font-bold mb-1">Status</label>
                        <select name="status" id="status" class="w-full p-2 border rounded" required>
                            <option value="">Pilih Status</option>
                            <option value="Hadir" ${attendance.status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                            <option value="Sakit" ${attendance.status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                            <option value="Izin" ${attendance.status === 'Izin' ? 'selected' : ''}>Izin</option>
                            <option value="Alpha" ${attendance.status === 'Alpha' ? 'selected' : ''}>Alpha</option>
                        </select>
                    </div>
                `;
                showDataModal("Ubah Data Kehadiran", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedAttendance = {
                        date: formData.get('date'),
                        studentName: formData.get('studentName'),
                        status: formData.get('status')
                    };
                    try {
                        await window.updateDoc(getDocRef('attendance', editingItem.id), updatedAttendance);
                        closeDataModal();
                        showMessage('Data kehadiran berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating attendance:", error);
                        showMessage(`Gagal memperbarui kehadiran: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteAttendance = (attendanceId) => {
                itemToDelete = attendanceId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus data kehadiran ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('attendance', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Data kehadiran berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting attendance:", error);
                        showMessage(`Gagal menghapus kehadiran: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderProgramSemesterTahunanContent() {
                // Initialize listener for this data if not already done
                initializeProgramSemesterTahunanListener();

                let rowsHtml = '';
                if (programSemesterTahunan.length > 0) {
                    programSemesterTahunan.forEach(program => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${program.programName}</td>
                                <td class="py-3 px-4">${program.description}</td>
                                <td class="py-3 px-4">${program.year}</td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editProgramSemesterTahunan('${program.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteProgramSemesterTahunan('${program.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="4" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada program semester atau tahunan.</td></tr>`;
                }

                const contentHtml = `
                    <div id="program-semester-tahunan-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Nama Program</th>
                                        <th class="py-3 px-4 text-left">Deskripsi</th>
                                        <th class="py-3 px-4 text-left">Tahun</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addProgramSemesterTahunan = () => {
                editingItem = null;
                const formHtml = `
                    <input name="programName" placeholder="Nama Program" class="w-full p-2 border rounded" required />
                    <textarea name="description" placeholder="Deskripsi Program" class="w-full p-2 border rounded" rows="3"></textarea>
                    <input name="year" placeholder="Tahun" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Tambah Program Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newProgram = {
                        programName: formData.get('programName'),
                        description: formData.get('description'),
                        year: formData.get('year')
                    };
                    try {
                        await window.addDoc(getCollectionRef('semester_programs'), newProgram);
                        closeDataModal();
                        showMessage('Program baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding program semester tahunan:", error);
                        showMessage(`Gagal menambahkan program: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editProgramSemesterTahunan = (programId) => {
                const program = programSemesterTahunan.find(p => p.id === programId);
                if (!program) return;
                editingItem = program;
                const formHtml = `
                    <input name="programName" placeholder="Nama Program" value="${program.programName}" class="w-full p-2 border rounded" required />
                    <textarea name="description" placeholder="Deskripsi Program" class="w-full p-2 border rounded" rows="3">${program.description}</textarea>
                    <input name="year" placeholder="Tahun" value="${program.year}" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Ubah Program", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedProgram = {
                        programName: formData.get('programName'),
                        description: formData.get('description'),
                        year: formData.get('year')
                    };
                    try {
                        await window.updateDoc(getDocRef('semester_programs', editingItem.id), updatedProgram);
                        closeDataModal();
                        showMessage('Program berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating program semester tahunan:", error);
                        showMessage(`Gagal memperbarui program: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteProgramSemesterTahunan = (programId) => {
                itemToDelete = programId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus program ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('semester_programs', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Program berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting program semester tahunan:", error);
                        showMessage(`Gagal menghapus program: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderKalenderPendidikanContent() {
                // Initialize listener for this data if not already done
                initializeKalenderPendidikanListener();

                let rowsHtml = '';
                if (kalenderPendidikan.length > 0) {
                    kalenderPendidikan.forEach(event => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${event.eventName}</td>
                                <td class="py-3 px-4">${new Date(event.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                <td class="py-3 px-4">${event.notes}</td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editCalendarEvent('${event.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteCalendarEvent('${event.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="4" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada acara dalam kalender pendidikan.</td></tr>`;
                }

                const contentHtml = `
                    <div id="kalender-pendidikan-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Nama Acara</th>
                                        <th class="py-3 px-4 text-left">Tanggal</th>
                                        <th class="py-3 px-4 text-left">Catatan</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addCalendarEvent = () => {
                editingItem = null;
                const formHtml = `
                    <input name="eventName" placeholder="Nama Acara" class="w-full p-2 border rounded" required />
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" class="w-full p-2 border rounded" required />
                    </div>
                    <textarea name="notes" placeholder="Catatan" class="w-full p-2 border rounded" rows="3"></textarea>
                `;
                showDataModal("Tambah Acara Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newEvent = {
                        eventName: formData.get('eventName'),
                        date: formData.get('date'),
                        notes: formData.get('notes')
                    };
                    try {
                        await window.addDoc(getCollectionRef('calendar_events'), newEvent);
                        closeDataModal();
                        showMessage('Acara baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding calendar event:", error);
                        showMessage(`Gagal menambahkan acara: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editCalendarEvent = (eventId) => {
                const event = kalenderPendidikan.find(ev => ev.id === eventId);
                if (!event) return;
                editingItem = event;
                const formHtml = `
                    <input name="eventName" placeholder="Nama Acara" value="${event.eventName}" class="w-full p-2 border rounded" required />
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" value="${event.date}" class="w-full p-2 border rounded" required />
                    </div>
                    <textarea name="notes" placeholder="Catatan" class="w-full p-2 border rounded" rows="3">${event.notes}</textarea>
                `;
                showDataModal("Ubah Acara", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedEvent = {
                        eventName: formData.get('eventName'),
                        date: formData.get('date'),
                        notes: formData.get('notes')
                    };
                    try {
                        await window.updateDoc(getDocRef('calendar_events', editingItem.id), updatedEvent);
                        closeDataModal();
                        showMessage('Acara berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating calendar event:", error);
                        showMessage(`Gagal memperbarui acara: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteCalendarEvent = (eventId) => {
                itemToDelete = eventId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus acara ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('calendar_events', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Acara berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting calendar event:", error);
                        showMessage(`Gagal menghapus acara: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderDaftarNilaiContent() {
                // Initialize listener for this data if not already done
                initializeDaftarNilaiListener();

                let rowsHtml = '';
                if (daftarNilai.length > 0) {
                    daftarNilai.forEach(entry => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${entry.subjectName}</td>
                                <td class="py-3 px-4">
                                    <a href="${entry.googleSheetLink}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                        Buka Link
                                    </a>
                                </td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editDaftarNilaiEntry('${entry.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteDaftarNilaiEntry('${entry.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="3" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada entri daftar nilai.</td></tr>`;
                }

                const contentHtml = `
                    <div id="daftar-nilai-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Mata Pelajaran</th>
                                        <th class="py-3 px-4 text-left">Link Google Sheet</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addDaftarNilaiEntry = () => {
                editingItem = null;
                const formHtml = `
                    <input name="subjectName" placeholder="Nama Mata Pelajaran" class="w-full p-2 border rounded" required />
                    <input type="url" name="googleSheetLink" placeholder="Link Google Sheet" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Tambah Entri Daftar Nilai Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newEntry = {
                        subjectName: formData.get('subjectName'),
                        googleSheetLink: formData.get('googleSheetLink')
                    };
                    try {
                        await window.addDoc(getCollectionRef('grades'), newEntry);
                        closeDataModal();
                        showMessage('Entri daftar nilai baru berhasil ditambahkan.', 'Berhasil');
                    }
                     catch (error) {
                        console.error("Error adding daftar nilai entry:", error);
                        showMessage(`Gagal menambahkan entri: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editDaftarNilaiEntry = (entryId) => {
                const entry = daftarNilai.find(e => e.id === entryId);
                if (!entry) return;
                editingItem = entry;
                const formHtml = `
                    <input name="subjectName" placeholder="Nama Mata Pelajaran" value="${entry.subjectName}" class="w-full p-2 border rounded" required />
                    <input type="url" name="googleSheetLink" placeholder="Link Google Sheet" value="${entry.googleSheetLink}" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Ubah Entri Daftar Nilai", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedEntry = {
                        subjectName: formData.get('subjectName'),
                        googleSheetLink: formData.get('googleSheetLink')
                    };
                    try {
                        await window.updateDoc(getDocRef('grades', editingItem.id), updatedEntry);
                        closeDataModal();
                        showMessage('Entri daftar nilai berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating daftar nilai entry:", error);
                        showMessage(`Gagal memperbarui entri: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteDaftarNilaiEntry = (entryId) => {
                itemToDelete = entryId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus entri daftar nilai ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('grades', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Entri daftar nilai berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting daftar nilai entry:", error);
                        showMessage(`Gagal menghapus entri: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderAsesmenContent() {
                // Initialize listener for this data if not already done
                initializeAsesmenListener();

                let rowsHtml = '';
                if (asesmen.length > 0) {
                    asesmen.forEach(assessment => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${assessment.assessmentName}</td>
                                <td class="py-3 px-4">${new Date(assessment.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                <td class="py-3 px-4">${assessment.subject}</td>
                                <td class="py-3 px-4">
                                    <a href="${assessment.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                        Buka Link
                                    </a>
                                </td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editAssessment('${assessment.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteAssessment('${assessment.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="5" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada data asesmen.</td></tr>`;
                }

                const contentHtml = `
                    <div id="asesmen-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Nama Asesmen</th>
                                        <th class="py-3 px-4 text-left">Tanggal</th>
                                        <th class="py-3 px-4 text-left">Mata Pelajaran</th>
                                        <th class="py-3 px-4 text-left">Link</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addAssessment = () => {
                editingItem = null;
                const formHtml = `
                    <input name="assessmentName" placeholder="Nama Asesmen" class="w-full p-2 border rounded" required />
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" class="w-full p-2 border rounded" required />
                    </div>
                    <input name="subject" placeholder="Mata Pelajaran" class="w-full p-2 border rounded" required />
                    <input type="url" name="link" placeholder="Link Asesmen (URL)" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Tambah Asesmen Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newAssessment = {
                        assessmentName: formData.get('assessmentName'),
                        date: formData.get('date'),
                        subject: formData.get('subject'),
                        link: formData.get('link')
                    };
                    try {
                        await window.addDoc(getCollectionRef('assessments'), newAssessment);
                        closeDataModal();
                        showMessage('Asesmen baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding assessment:", error);
                        showMessage(`Gagal menambahkan asesmen: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editAssessment = (assessmentId) => {
                const assessment = asesmen.find(a => a.id === assessmentId);
                if (!assessment) return;
                editingItem = assessment;
                const formHtml = `
                    <input name="assessmentName" placeholder="Nama Asesmen" value="${assessment.assessmentName}" class="w-full p-2 border rounded" required />
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" value="${assessment.date}" class="w-full p-2 border rounded" required />
                    </div>
                    <input name="subject" placeholder="Mata Pelajaran" value="${assessment.subject}" class="w-full p-2 border rounded" required />
                    <input type="url" name="link" placeholder="Link Asesmen (URL)" value="${assessment.link}" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Ubah Asesmen", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedAssessment = {
                        assessmentName: formData.get('assessmentName'),
                        date: formData.get('date'),
                        subject: formData.get('subject'),
                        link: formData.get('link')
                    };
                    try {
                        await window.updateDoc(getDocRef('assessments', editingItem.id), updatedAssessment);
                        closeDataModal();
                        showMessage('Asesmen berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating assessment:", error);
                        showMessage(`Gagal memperbarui asesmen: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteAssessment = (assessmentId) => {
                itemToDelete = assessmentId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus asesmen ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('assessments', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Asesmen berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting assessment:", error);
                        showMessage(`Gagal menghapus asesmen: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderKaryaInovatifContent() {
                // Initialize listener for this data if not already done
                initializeKaryaInovatifListener();

                let rowsHtml = '';
                if (karyaInovatif.length > 0) {
                    karyaInovatif.forEach(work => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${work.workTitle}</td>
                                <td class="py-3 px-4">${work.description}</td>
                                <td class="py-3 px-4">${work.year}</td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editKaryaInovatif('${work.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteKaryaInovatif('${work.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="4" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada data karya inovatif.</td></tr>`;
                }

                const contentHtml = `
                    <div id="karya-inovatif-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Judul Karya</th>
                                        <th class="py-3 px-4 text-left">Deskripsi</th>
                                        <th class="py-3 px-4 text-left">Tahun</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addKaryaInovatif = () => {
                editingItem = null;
                const formHtml = `
                    <input name="workTitle" placeholder="Judul Karya" class="w-full p-2 border rounded" required />
                    <textarea name="description" placeholder="Deskripsi Karya" class="w-full p-2 border rounded" rows="3"></textarea>
                    <input name="year" placeholder="Tahun" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Tambah Karya Inovatif Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newWork = {
                        workTitle: formData.get('workTitle'),
                        description: formData.get('description'),
                        year: formData.get('year')
                    };
                    try {
                        await window.addDoc(getCollectionRef('innovative_works'), newWork);
                        closeDataModal();
                        showMessage('Karya inovatif baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding karya inovatif:", error);
                        showMessage(`Gagal menambahkan karya: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editKaryaInovatif = (workId) => {
                const work = karyaInovatif.find(w => w.id === workId);
                if (!work) return;
                editingItem = work;
                const formHtml = `
                    <input name="workTitle" placeholder="Judul Karya" value="${work.workTitle}" class="w-full p-2 border rounded" required />
                    <textarea name="description" placeholder="Deskripsi Karya" class="w-full p-2 border rounded" rows="3">${work.description}</textarea>
                    <input name="year" placeholder="Tahun" value="${work.year}" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Ubah Karya Inovatif", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedWork = {
                        workTitle: formData.get('workTitle'),
                        description: formData.get('description'),
                        year: formData.get('year')
                    };
                    try {
                        await window.updateDoc(getDocRef('innovative_works', editingItem.id), updatedWork);
                        closeDataModal();
                        showMessage('Karya inovatif berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating karya inovatif:", error);
                        showMessage(`Gagal memperbarui karya: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteKaryaInovatif = (workId) => {
                itemToDelete = workId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus karya inovatif ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('innovative_works', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Karya inovatif berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting karya inovatif:", error);
                        showMessage(`Gagal menghapus karya: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderProgramKerjaGuruContent() {
                // Initialize listener for this data if not already done
                initializeProgramKerjaGuruListener();

                let rowsHtml = '';
                if (programKerjaGuru.length > 0) {
                    programKerjaGuru.forEach(program => {
                        const statusClass =
                            program.status === 'Berjalan' ? 'bg-blue-100 text-blue-800' :
                            program.status === 'Selesai' ? 'bg-green-100 text-green-800' :
                            'bg-yellow-100 text-yellow-800';
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${program.programName}</td>
                                <td class="py-3 px-4">${program.description}</td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">
                                        ${program.status}
                                    </span>
                               </td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editProgramKerjaGuru('${program.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteProgramKerjaGuru('${program.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="4" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada program kerja guru.</td></tr>`;
                }

                const contentHtml = `
                    <div id="program-kerja-guru-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Nama Program</th>
                                        <th class="py-3 px-4 text-left">Deskripsi</th>
                                        <th class="py-3 px-4 text-left">Status</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addProgramKerjaGuru = () => {
                editingItem = null;
                const formHtml = `
                    <input name="programName" placeholder="Nama Program" class="w-full p-2 border rounded" required />
                    <textarea name="description" placeholder="Deskripsi Program" class="w-full p-2 border rounded" rows="3"></textarea>
                    <div>
                        <label for="status" class="block text-gray-700 text-sm font-bold mb-1">Status</label>
                        <select name="status" id="status" class="w-full p-2 border rounded" required>
                            <option value="">Pilih Status</option>
                            <option value="Berjalan">Berjalan</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Belum Dimulai">Belum Dimulai</option>
                        </select>
                    </div>
                `;
                showDataModal("Tambah Program Kerja Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newProgram = {
                        programName: formData.get('programName'),
                        description: formData.get('description'),
                        status: formData.get('status')
                    };
                    try {
                        await window.addDoc(getCollectionRef('teacher_programs'), newProgram);
                        closeDataModal();
                        showMessage('Program kerja baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding program kerja guru:", error);
                        showMessage(`Gagal menambahkan program kerja: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editProgramKerjaGuru = (programId) => {
                const program = programKerjaGuru.find(p => p.id === programId);
                if (!program) return;
                editingItem = program;
                const formHtml = `
                    <input name="programName" placeholder="Nama Program" value="${program.programName}" class="w-full p-2 border rounded" required />
                    <textarea name="description" placeholder="Deskripsi Program" class="w-full p-2 border rounded" rows="3">${program.description}</textarea>
                    <div>
                        <label for="status" class="block text-gray-700 text-sm font-bold mb-1">Status</label>
                        <select name="status" id="status" class="w-full p-2 border rounded" required>
                            <option value="">Pilih Status</option>
                            <option value="Berjalan" ${program.status === 'Berjalan' ? 'selected' : ''}>Berjalan</option>
                            <option value="Selesai" ${program.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                            <option value="Belum Dimulai" ${program.status === 'Belum Dimulai' ? 'selected' : ''}>Belum Dimulai</option>
                        </select>
                    </div>
                `;
                showDataModal("Ubah Program Kerja", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedProgram = {
                        programName: formData.get('programName'),
                        description: formData.get('description'),
                        status: formData.get('status')
                    };
                    try {
                        await window.updateDoc(getDocRef('teacher_programs', editingItem.id), updatedProgram);
                        closeDataModal();
                        showMessage('Program kerja berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating program kerja guru:", error);
                        showMessage(`Gagal memperbarui program kerja: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteProgramKerjaGuru = (programId) => {
                itemToDelete = programId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus program kerja ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('teacher_programs', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Program kerja berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting program kerja guru:", error);
                        showMessage(`Gagal menghapus program kerja: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderModulAjarContent() {
                // Initialize listener for this data if not already done
                initializeModulAjarListener();

                let rowsHtml = '';
                if (modulAjar.length > 0) {
                    modulAjar.forEach(module => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${module.title}</td>
                                <td class="py-3 px-4">
                                    <a href="${module.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                                        Buka Link
                                    </a>
                                </td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editModulAjar('${module.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="downloadSingleModulAjar('${module.id}')" class="text-blue-600 hover:text-blue-800"> <i data-lucide="download" class="lucide lucide-download" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteModulAjar('${module.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="3" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada modul ajar.</td></tr>`;
                }

                const contentHtml = `
                    <div id="modul-ajar-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Judul Modul</th>
                                        <th class="py-3 px-4 text-left">Link</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addModulAjar = () => {
                editingItem = null;
                const formHtml = `
                    <input name="title" placeholder="Judul Modul" class="w-full p-2 border rounded" required />
                    <input type="url" name="link" placeholder="Link Modul (URL)" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Tambah Modul Ajar Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newModule = {
                        title: formData.get('title'),
                        link: formData.get('link')
                    };
                    try {
                        await window.addDoc(getCollectionRef('teaching_modules'), newModule);
                        closeDataModal();
                        showMessage('Modul ajar baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding modul ajar:", error);
                        showMessage(`Gagal menambahkan modul ajar: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editModulAjar = (moduleId) => {
                const module = modulAjar.find(m => m.id === moduleId);
                if (!module) return;
                editingItem = module;
                const formHtml = `
                    <input name="title" placeholder="Judul Modul" value="${module.title}" class="w-full p-2 border rounded" required />
                    <input type="url" name="link" placeholder="Link Modul (URL)" value="${module.link}" class="w-full p-2 border rounded" required />
                `;
                showDataModal("Ubah Modul Ajar", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedModule = {
                        title: formData.get('title'),
                        link: formData.get('link')
                    };
                    try {
                        await window.updateDoc(getDocRef('teaching_modules', editingItem.id), updatedModule);
                        closeDataModal();
                        showMessage('Modul ajar berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating modul ajar:", error);
                        showMessage(`Gagal memperbarui modul ajar: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteModulAjar = (moduleId) => {
                itemToDelete = moduleId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus modul ajar ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('teaching_modules', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Modul ajar berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting modul ajar:", error);
                        showMessage(`Gagal menghapus modul ajar: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderRiwayatPelatihanContent() {
                // Initialize listener for this data if not already done
                initializeRiwayatPelatihanListener();

                let rowsHtml = '';
                if (riwayatPelatihan.length > 0) {
                    riwayatPelatihan.forEach(training => {
                        rowsHtml += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3 px-4">${training.topic}</td>
                                <td class="py-3 px-4">${training.organizer}</td>
                                <td class="py-3 px-4">${new Date(training.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                <td class="py-3 px-4 flex gap-2">
                                    <button onclick="editRiwayatPelatihan('${training.id}')" class="text-yellow-600 hover:text-yellow-800"> <i data-lucide="edit" class="lucide lucide-edit" style="width: 18px; height: 18px;"></i> </button>
                                    <button onclick="confirmDeleteRiwayatPelatihan('${training.id}')" class="text-red-600 hover:text-red-800"> <i data-lucide="trash-2" class="lucide lucide-trash-2" style="width: 18px; height: 18px;"></i> </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    rowsHtml = `<tr><td colspan="4" class="py-3 px-4 text-gray-500 italic text-center">Tidak ada riwayat pelatihan.</td></tr>`;
                }

                const contentHtml = `
                    <div id="riwayat-pelatihan-print-area" class="bg-white p-6 rounded-lg shadow-md print-area">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead>
                                    <tr class="bg-blue-100 text-blue-800">
                                        <th class="py-3 px-4 text-left">Topik</th>
                                        <th class="py-3 px-4 text-left">Penyelenggara</th>
                                        <th class="py-3 px-4 text-left">Tanggal</th>
                                        <th class="py-3 px-4 text-left w-24">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rowsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return contentHtml;
            }

            window.addRiwayatPelatihan = () => {
                editingItem = null;
                const formHtml = `
                    <input name="topic" placeholder="Topik Pelatihan" class="w-full p-2 border rounded" required />
                    <input name="organizer" placeholder="Penyelenggara" class="w-full p-2 border rounded" required />
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" class="w-full p-2 border rounded" required />
                    </div>
                `;
                showDataModal("Tambah Riwayat Pelatihan Baru", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const newTraining = {
                        topic: formData.get('topic'),
                        organizer: formData.get('organizer'),
                        date: formData.get('date')
                    };
                    try {
                        await window.addDoc(getCollectionRef('trainings'), newTraining);
                        closeDataModal();
                        showMessage('Riwayat pelatihan baru berhasil ditambahkan.', 'Berhasil');
                    } catch (error) {
                        console.error("Error adding training:", error);
                        showMessage(`Gagal menambahkan pelatihan: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.editRiwayatPelatihan = (trainingId) => {
                const training = riwayatPelatihan.find(t => t.id === trainingId);
                if (!training) return;
                editingItem = training;
                const formHtml = `
                    <input name="topic" placeholder="Topik Pelatihan" value="${training.topic}" class="w-full p-2 border rounded" required />
                    <input name="organizer" placeholder="Penyelenggara" value="${training.organizer}" class="w-full p-2 border rounded" required />
                    <div>
                        <label for="date" class="block text-gray-700 text-sm font-bold mb-1">Tanggal</label>
                        <input type="date" name="date" id="date" value="${training.date}" class="w-full p-2 border rounded" required />
                    </div>
                `;
                showDataModal("Ubah Riwayat Pelatihan", formHtml, async (formElement) => {
                    const formData = new FormData(formElement);
                    const updatedTraining = {
                        topic: formData.get('topic'),
                        organizer: formData.get('organizer'),
                        date: formData.get('date')
                    };
                    try {
                        await window.updateDoc(getDocRef('trainings', editingItem.id), updatedTraining);
                        closeDataModal();
                        showMessage('Riwayat pelatihan berhasil diperbarui.', 'Berhasil');
                    } catch (error) {
                        console.error("Error updating training:", error);
                        showMessage(`Gagal memperbarui pelatihan: ${error.message}`, 'Kesalahan');
                    }
                });
            };

            window.confirmDeleteRiwayatPelatihan = (trainingId) => {
                itemToDelete = trainingId;
                showConfirmDeleteModal("Apakah Anda yakin ingin menghapus riwayat pelatihan ini?", async () => {
                    try {
                        await window.deleteDoc(getDocRef('trainings', itemToDelete));
                        closeConfirmDeleteModal();
                        showMessage('Riwayat pelatihan berhasil dihapus.', 'Berhasil');
                    } catch (error) {
                        console.error("Error deleting training:", error);
                        showMessage(`Gagal menghapus pelatihan: ${error.message}`, 'Kesalahan');
                    }
                });
            };


            function renderDashboardContent() {
                const cardData = [
                    { title: "Daftar Siswa", icon: "users", menu: "Daftar Siswa", bgColor: "bg-rose-500" },
                    { title: "Jadwal Mengajar", icon: "calendar", menu: "Jadwal Mengajar", bgColor: "bg-emerald-500" },
                    { title: "Daftar Hadir", icon: "check-square", menu: "Daftar Hadir", bgColor: "bg-amber-500" },
                    { title: "Program Semester & Tahunan", icon: "book", menu: "Program Semester & Tahunan", bgColor: "bg-fuchsia-500" },
                    { title: "Kalender Pendidikan", icon: "calendar", menu: "Kalender Pendidikan", bgColor: "bg-violet-500" },
                    { title: "Daftar Nilai", icon: "clipboard-list", menu: "Daftar Nilai", bgColor: "bg-sky-500" },
                    { title: "Asesmen", icon: "target", menu: "Asesmen", bgColor: "bg-lime-500" },
                    { title: "Karya Inovatif", icon: "brain-circuit", menu: "Karya Inovatif", bgColor: "bg-orange-500" },
                    { title: "Program Kerja Guru", icon: "award", menu: "Program Kerja Guru", bgColor: "bg-cyan-500" },
                    { title: "Modul Ajar", icon: "book", menu: "Modul Ajar", bgColor: "bg-indigo-500" },
                    { title: "Riwayat Pelatihan", icon: "graduation-cap", menu: "Riwayat Pelatihan", bgColor: "bg-purple-500" },
                ];

                let cardsHtml = '';
                cardData.forEach(card => {
                    // Determine the text color for the icon based on the card's background color
                    const iconTextColorClass = card.bgColor.replace('bg-', 'text-'); // e.g., 'bg-rose-500' -> 'text-rose-500'

                    cardsHtml += `
                        <div class="${card.bgColor} rounded-lg shadow-md p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-lg transition-shadow duration-300 transform hover:-translate-y-1"
                            onclick="setActiveMenu('${card.menu}')">
                            <div class="bg-white ${iconTextColorClass} p-4 rounded-full mb-4"> <i data-lucide="${card.icon}" class="lucide lucide-${card.icon}" style="width: 36px; height: 36px;"></i> </div>
                            <h3 class="text-xl font-semibold text-white">${card.title}</h3>
                        </div>
                    `;
                });

                const contentHtml = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${cardsHtml}
                    </div>
                `;
                return contentHtml;
            }


            // --- Centralized Page Content Renderer ---
            function renderPageContent() {
                let contentHtml = '';
                let headerTitle = '';
                let headerIconHtml = '';
                let headerOnBack = null;
                let headerOnAdd = null;
                let showGlobalDownload = true;

                switch (activeMenu) {
                    case 'Dashboard':
                        headerTitle = "Dashboard";
                        headerIconHtml = '<i data-lucide="layout-dashboard" style="width: 24px; height: 24px;"></i>';
                        showGlobalDownload = false; // No download button for Dashboard
                        contentHtml = renderDashboardContent();
                        break;
                    case 'Profil Guru':
                        headerTitle = "Profil Guru";
                        headerIconHtml = '<i data-lucide="user-circle" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        contentHtml = renderProfilGuruContent();
                        break;
                    case 'Jadwal Mengajar':
                        headerTitle = "Jadwal Mengajar";
                        headerIconHtml = '<i data-lucide="calendar" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addLesson()';
                        contentHtml = renderJadwalMengajarContent();
                        break;
                    case 'Daftar Siswa':
                        headerTitle = "Daftar Siswa";
                        headerIconHtml = '<i data-lucide="users" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addStudent()';
                        contentHtml = renderDaftarSiswaContent();
                        break;
                    case 'Daftar Hadir':
                        headerTitle = "Daftar Hadir";
                        headerIconHtml = '<i data-lucide="check-square" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addAttendance()';
                        contentHtml = renderDaftarHadirContent();
                        break;
                    case 'Program Semester & Tahunan':
                        headerTitle = "Program Semester & Tahunan";
                        headerIconHtml = '<i data-lucide="book" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addProgramSemesterTahunan()';
                        contentHtml = renderProgramSemesterTahunanContent();
                        break;
                    case 'Kalender Pendidikan':
                        headerTitle = "Kalender Pendidikan";
                        headerIconHtml = '<i data-lucide="calendar" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addCalendarEvent()';
                        contentHtml = renderKalenderPendidikanContent();
                        break;
                    case 'Daftar Nilai':
                        headerTitle = "Daftar Nilai";
                        headerIconHtml = '<i data-lucide="clipboard-list" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addDaftarNilaiEntry()';
                        contentHtml = renderDaftarNilaiContent();
                        break;
                    case 'Asesmen':
                        headerTitle = "Asesmen";
                        headerIconHtml = '<i data-lucide="target" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addAssessment()';
                        contentHtml = renderAsesmenContent();
                        break;
                    case 'Karya Inovatif':
                        headerTitle = "Karya Inovatif";
                        headerIconHtml = '<i data-lucide="brain-circuit" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addKaryaInovatif()';
                        contentHtml = renderKaryaInovatifContent();
                        break;
                    case 'Program Kerja Guru':
                        headerTitle = "Program Kerja Guru";
                        headerIconHtml = '<i data-lucide="award" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addProgramKerjaGuru()';
                        contentHtml = renderProgramKerjaGuruContent();
                        break;
                    case 'Modul Ajar':
                        headerTitle = "Modul Ajar";
                        headerIconHtml = '<i data-lucide="book" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addModulAjar()';
                        showGlobalDownload = false; // Modul Ajar has individual download buttons
                        contentHtml = renderModulAjarContent();
                        break;
                    case 'Riwayat Pelatihan':
                        headerTitle = "Riwayat Pelatihan";
                        headerIconHtml = '<i data-lucide="graduation-cap" style="width: 24px; height: 24px;"></i>';
                        headerOnBack = 'Dashboard';
                        headerOnAdd = 'addRiwayatPelatihan()';
                        contentHtml = renderRiwayatPelatihanContent();
                        break;
                    default:
                        headerTitle = "Dashboard";
                        headerIconHtml = '<i data-lucide="layout-dashboard" style="width: 24px; height: 24px;"></i>';
                        showGlobalDownload = false;
                        contentHtml = renderDashboardContent();
                        break;
                }

                mainContent.innerHTML = renderHeader(headerTitle, headerIconHtml, headerOnBack, headerOnAdd, showGlobalDownload) + contentHtml;
                lucide.createIcons(); // Re-create icons for the newly injected HTML
            }


            // --- Render Function ---
            function renderApp() {
                if (!isLoggedIn) {
                    loginPage.style.display = 'flex';
                    appContainer.style.display = 'none';
                } else {
                    loginPage.style.display = 'none';
                    appContainer.style.display = 'flex';

                    // Update Header Info
                    guruNameSpan.textContent = guruProfile.name;
                    guruPhotoImg.src = guruProfile.photo;
                    guruPhotoImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/40x40/E0E7FF/4F46E5?text=G'; };
                    guruPhotoImg.onclick = () => setActiveMenu('Profil Guru');

                    renderPageContent(); // Call the centralized content renderer
                }

                // Render Modals
                if (messageModal.isOpen) {
                    messageModalElem.style.display = 'flex';
                    messageModalTitleElem.textContent = messageModal.title;
                    messageModalMessageElem.textContent = messageModal.message;
                } else {
                    messageModalElem.style.display = 'none';
                }

                if (dataModal.isOpen) {
                    dataModalElem.style.display = 'flex';
                    dataModalTitleElem.textContent = dataModal.title;
                    dataModalFormElem.innerHTML = dataModal.formHtml;
                    lucide.createIcons(); // Re-create icons inside modal form
                } else {
                    dataModalElem.style.display = 'none';
                }

                if (confirmDeleteModal.isOpen) {
                    confirmDeleteModalElem.style.display = 'flex';
                    confirmDeleteModalMessageElem.textContent = confirmDeleteModal.message;
                } else {
                    confirmDeleteModalElem.style.display = 'none';
                }
            }

            // --- Event Listeners Global ---
            loginButton.onclick = () => {
                isLoggedIn = true; // This will trigger onAuthStateChanged to fetch data
                renderApp();
            };

            logoutButton.onclick = async () => {
                try {
                    await auth.signOut();
                    isLoggedIn = false;
                    activeMenu = 'Dashboard'; // Reset active menu on logout
                    // Reset all loaded flags to false so data is re-fetched on next login/access
                    studentsLoaded = false;
                    scheduleLoaded = false;
                    daftarHadirLoaded = false;
                    programSemesterTahunanLoaded = false;
                    kalenderPendidikanLoaded = false;
                    daftarNilaiLoaded = false;
                    asesmenLoaded = false;
                    karyaInovatifLoaded = false;
                    programKerjaGuruLoaded = false;
                    modulAjarLoaded = false;
                    riwayatPelatihanLoaded = false;

                    // Clear local data states (optional, as snapshots would repopulate)
                    studentData = [];
                    schedule = JSON.parse(JSON.stringify(initialSchedule));
                    daftarHadir = [];
                    programSemesterTahunan = [];
                    kalenderPendidikan = [];
                    daftarNilai = [];
                    asesmen = [];
                    karyaInovatif = [];
                    programKerjaGuru = [];
                    modulAjar = [];
                    riwayatPelatihan = [];

                    renderApp();
                    showMessage('Anda telah berhasil keluar.', 'Sesi Berakhir');
                } catch (error) {
                    console.error("Error signing out:", error);
                    showMessage(`Gagal keluar: ${error.message}`, 'Kesalahan');
                }
            };

            messageModalCloseButton.onclick = closeMessageModal;
            messageModalOkButton.onclick = closeMessageModal;

            dataModalCloseButton.onclick = closeDataModal;

            confirmDeleteModalCloseButton.onclick = closeConfirmDeleteModal;
            confirmDeleteModalCancelButton.onclick = closeConfirmDeleteModal;
            confirmDeleteModalConfirmButton.onclick = () => {
                if (confirmDeleteModal.onConfirm) {
                    confirmDeleteModal.onConfirm();
                }
            };

            // Function to set active menu and re-render
            function setActiveMenu(menu) {
                activeMenu = menu;
                renderApp();
            }
            window.setActiveMenu = setActiveMenu; // Expose to global scope for onclick attributes

            // Initial render on page load, will be handled by onAuthStateChanged
            loadingOverlay.style.display = 'flex'; // Show loading on initial load
        });
    </script>
</body>
</html>
